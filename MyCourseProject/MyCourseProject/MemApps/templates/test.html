{% extends "base.html" %}

{% block login %}
    {% if login %}
        <p>{{login}}</p>
    {% endif %}
{% endblock %}

{% block main %}
{% csrf_token %}
<div class="low allimages">
    {% for i in images %}
        {% if forloop.last %}
            <div class="images last-image" style="width: 49%;" image-data="{{i.date_mem}}">
        {% else %}
            <div class="images" style="width: 49%;">
        {% endif %}
                <div class="div-img-top">
                    <img src="{{ i.url_image.url }}" id="div-img-top">
                </div>
                <div class="img-body">
                    <h5 class="img-title">{{i.tags}}</h5>
                    <div class="form1">
                         <form method="POST" action="{% url 'gallery' %}">
                             {% csrf_token %}
                            <input type="hidden" name="mem_id" value="{{i.id}}">
                            <input class="btn btn-outline-secondary" id= "button-add" type="submit" value="Добавить">
                         </form>
                    </div>

                        {% if role == "admin" %}
                            <div class="form2">
                                <form method="POST" action="{% url 'delete' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="mem_id" value="{{i.id}}">
                                    <input class="btn btn-dark" type="submit" value="Удалить">
                                </form>
                            </div>

                        {% endif %}
                 </div>
            </div>
    {% endfor %}
</div>


<div>
    {% if images|length >= 3 %}
        <p class="text-center mt-2"><button class="btn btn-success load-more" id="load-more">Хочу еще мамасиков</button></p>
    {% endif %}
</div>



<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>

<script type="text/javascript">
    $('#load-more').on('click', function () {
        let lastImage = $('.last-image').attr('image-data')
        console.log(lastImage)
        let data = {
            lastImage: lastImage
        }
        $('.images').removeClass('last-image')
        $('.images').removeAttr('image-data')
        $.ajax({
            method: "GET",
            dataType: "json",
            data: data,
            url: '{% url "load-more-image" %}',
            success: function (data){
                console.log(data)
                let result = data['data']
                console.log(data)
                console.log('*****')
                console.log(result)
                if(!result){
                    $('.load-more').css('display', 'none')
                } else {
                    $.each(result, function(key, obj){
                    console.log(key, obj)
                    console.log(obj)
                    console.log(obj['last_image'])
                     if(obj['last_image']){
                        $('.allimages').append(
                            '<div class="images last-image" style="width: 49%;" image-data="' + obj['date_mem'] + '">' +
                            '<div class="div-img-top">'+
                            '<img src="media/' + obj['url_image'] + '" id="div-img-top">' +
                            '</div>'+
                            '<div class="img-body">' +
                            '<h5 class="img-title">' + obj['tags'] + '</h5>' +
                            '<div class="form1">'+
                            '<form method="POST" action="{% url 'gallery' %}">' +
                            '<input type="hidden" name="mem_id" value="' + obj['id'] + '">' +
                            '<input class="btn btn-outline-secondary" type="submit" id="button-add" value="Добавить">' +
                            '</form>' +
                            '</div>'+
                            '{% if role == "admin" %}' +
                                '<div class="form2">'+
                                '<form method="POST" action="{% url 'delete' %}">' +
                                    '<input type="hidden" name="mem_id" value="' + obj['id'] + '">' +
                                    '<input class="btn btn-dark" type="submit" value="Удалить">' +
                                '</form>' +
                                '</div>' +
                            '{% endif %}' +
                            '</div>'+
                            '</div>')
                            console.log(obj['url_image'] )
                     } else {
                       $('.allimages').append(
                            '<div class="images " style="width: 49%;">' +
                            '<div class="div-img-top">'+
                            '<img src="media/' + obj['url_image'] + '" id="div-img-top">' +
                            '</div>'+
                            '<div class="img-body">' +
                            '<h5 class="img-title">' + obj['tags'] + '</h5>' +
                            '<form method="POST" action="{% url 'gallery' %}">' +
                            '<div class="form1">'+
                            '<input type="hidden" name="mem_id" value="' + obj['id'] + '">' +
                            '<input class="btn btn-outline-secondary" id= "button-add" type="submit" value="Добавить">' +
                            '</form>' +
                            '</div>'+
                            '{% if role == "admin" %}' +
                            '<div class="form2">'+
                                '<form method="POST" action="{% url 'delete' %}">' +
                                    '<input type="hidden" name="mem_id" value="' + obj['id'] + '">' +
                                    '<input class="btn btn-dark" type="submit" value="Удалить">' +
                                '</form>' +
                            '</div>'+
                            '{% endif %}' +
                            '</div>'+
                            '</div>')
                            console.log(obj['url_image'] )
                     }

                    })
                }

            }
        })
    })
</script>

{% endblock %}






